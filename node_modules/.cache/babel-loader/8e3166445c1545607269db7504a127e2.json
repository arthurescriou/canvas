{"ast":null,"code":"import * as conf from './conf';\n\nconst dist2 = (o1, o2) => Math.pow(o1.x - o2.x, 2) + Math.pow(o1.y - o2.y, 2);\n\nconst iterate = bound => coord => {\n  const dx = (coord.x + conf.RADIUS > bound.width || coord.x < conf.RADIUS ? -coord.dx : coord.dx) * conf.FRICTION;\n  const dy = (coord.y + conf.RADIUS > bound.height || coord.y < conf.RADIUS ? -coord.dy : coord.dy) * conf.FRICTION;\n  if (Math.abs(dx) + Math.abs(dy) < conf.MINMOVE) return { ...coord,\n    dx: 0,\n    dy: 0\n  };\n  return {\n    x: coord.x + dx,\n    y: coord.y + dy,\n    dx,\n    dy\n  };\n};\n\nexport const click = state => event => {\n  const {\n    offsetX,\n    offsetY\n  } = event;\n  const target = state.pos.find(p => dist2(p, {\n    x: offsetX,\n    y: offsetY,\n    dx: 0,\n    dy: 0\n  }) < Math.pow(conf.RADIUS, 2) + 100);\n\n  if (target) {\n    target.dx += Math.random() * 10;\n    target.dy += Math.random() * 10;\n  }\n\n  return state;\n};\n\nconst collide = (o1, o2) => dist2(o1, o2) < Math.pow(2 * conf.RADIUS, 2);\n\nconst collideBoing = (p1, p2) => {// const nx = ((p2.x - p1.x) / 2) * conf.RADIUS\n  // const ny = ((p2.y - p1.y) / 2) * conf.RADIUS\n  // const gx = -ny\n  // const gy = nx\n  //\n  // const v1g = gx * p1.dx + gy * p1.dy\n  // const v2n = nx * p2.dx + ny * p2.dy\n  // const v2g = gx * p2.dx + gy * p2.dy\n  // const v1n = nx * p1.dx + ny * p1.dy\n  // p1.dx = nx * v2n + gx * v1g\n  // p1.dy = ny * v2n + gy * v1g\n  // p2.dx = nx * v1n + gx * v2g\n  // p2.dy = ny * v1n + gy * v2g\n  // console.log(p1.dx)\n};\n\nexport const step = state => {\n  state.pos.map((p1, i, arr) => {\n    arr.slice(i + 1).map(p2 => {\n      if (collide(p1, p2)) {\n        collideBoing(p1, p2);\n      }\n    });\n  });\n  if (state.player.invincible) state.player.invincible--;else state.pos.map((p1, i) => {\n    if (collide(p1, state.player.coord)) {\n      collideBoing(p1, state.player.coord);\n      state.player.coord.dx = 0;\n      state.player.coord.dy = 0;\n      state.player.life--;\n      state.player.invincible = 20;\n    }\n  });\n  return { ...state,\n    pos: state.pos.map(iterate(state.size))\n  };\n};\nexport const mouseMove = state => event => {\n  const {\n    offsetX,\n    offsetY\n  } = event;\n  state.player = { ...state.player,\n    coord: {\n      x: offsetX,\n      y: offsetY,\n      dx: 0,\n      dy: 0\n    }\n  };\n  return state;\n};\nexport const endOfGame = state => {\n  return state.player.life > 0;\n};","map":{"version":3,"sources":["/Users/arthur.escriou/workspace/canvas/src/components/canvas/state.ts"],"names":["conf","dist2","o1","o2","Math","pow","x","y","iterate","bound","coord","dx","RADIUS","width","FRICTION","dy","height","abs","MINMOVE","click","state","event","offsetX","offsetY","target","pos","find","p","random","collide","collideBoing","p1","p2","step","map","i","arr","slice","player","invincible","life","size","mouseMove","endOfGame"],"mappings":"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","sourcesContent":["import * as conf from './conf'\ntype Coord = { x: number; y: number; dx: number; dy: number }\ntype Size = { height: number; width: number }\nexport type State = {\n  pos: Array<Coord>\n  size: Size\n  player: { coord: Coord; life: number; invincible?: number }\n  endOfGame: boolean\n}\n\nconst dist2 = (o1: Coord, o2: Coord) =>\n  Math.pow(o1.x - o2.x, 2) + Math.pow(o1.y - o2.y, 2)\n\nconst iterate = (bound: Size) => (coord: Coord) => {\n  const dx =\n    (coord.x + conf.RADIUS > bound.width || coord.x < conf.RADIUS\n      ? -coord.dx\n      : coord.dx) * conf.FRICTION\n  const dy =\n    (coord.y + conf.RADIUS > bound.height || coord.y < conf.RADIUS\n      ? -coord.dy\n      : coord.dy) * conf.FRICTION\n  if (Math.abs(dx) + Math.abs(dy) < conf.MINMOVE)\n    return { ...coord, dx: 0, dy: 0 }\n  return {\n    x: coord.x + dx,\n    y: coord.y + dy,\n    dx,\n    dy,\n  }\n}\n\nexport const click =\n  (state: State) =>\n  (event: PointerEvent): State => {\n    const { offsetX, offsetY } = event\n    const target = state.pos.find(\n      (p) =>\n        dist2(p, { x: offsetX, y: offsetY, dx: 0, dy: 0 }) <\n        Math.pow(conf.RADIUS, 2) + 100\n    )\n    if (target) {\n      target.dx += Math.random() * 10\n      target.dy += Math.random() * 10\n    }\n    return state\n  }\n\nconst collide = (o1: Coord, o2: Coord) =>\n  dist2(o1, o2) < Math.pow(2 * conf.RADIUS, 2)\n\nconst collideBoing = (p1: Coord, p2: Coord) => {\n  // const nx = ((p2.x - p1.x) / 2) * conf.RADIUS\n  // const ny = ((p2.y - p1.y) / 2) * conf.RADIUS\n  // const gx = -ny\n  // const gy = nx\n  //\n  // const v1g = gx * p1.dx + gy * p1.dy\n  // const v2n = nx * p2.dx + ny * p2.dy\n  // const v2g = gx * p2.dx + gy * p2.dy\n  // const v1n = nx * p1.dx + ny * p1.dy\n  // p1.dx = nx * v2n + gx * v1g\n  // p1.dy = ny * v2n + gy * v1g\n  // p2.dx = nx * v1n + gx * v2g\n  // p2.dy = ny * v1n + gy * v2g\n  // console.log(p1.dx)\n}\n\nexport const step = (state: State) => {\n  state.pos.map((p1, i, arr) => {\n    arr.slice(i + 1).map((p2) => {\n      if (collide(p1, p2)) {\n        collideBoing(p1, p2)\n      }\n    })\n  })\n  if (state.player.invincible) state.player.invincible--\n  else\n    state.pos.map((p1, i) => {\n      if (collide(p1, state.player.coord)) {\n        collideBoing(p1, state.player.coord)\n        state.player.coord.dx = 0\n        state.player.coord.dy = 0\n        state.player.life--\n        state.player.invincible = 20\n      }\n    })\n  return {\n    ...state,\n    pos: state.pos.map(iterate(state.size)),\n  }\n}\n\nexport const mouseMove =\n  (state: State) =>\n  (event: PointerEvent): State => {\n    const { offsetX, offsetY } = event\n    state.player = {\n      ...state.player,\n      coord: { x: offsetX, y: offsetY, dx: 0, dy: 0 },\n    }\n    return state\n  }\n\nexport const endOfGame = (state: State): boolean => {\n  return state.player.life > 0\n}\n"]},"metadata":{},"sourceType":"module"}