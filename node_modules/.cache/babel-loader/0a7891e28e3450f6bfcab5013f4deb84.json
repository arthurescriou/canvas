{"ast":null,"code":"import * as conf from './conf';\n\nconst dist2 = (o1, o2) => Math.pow(o1.x - o2.x, 2) + Math.pow(o1.y - o2.y, 2);\n\nconst iterate = bound => ball => {\n  const invincible = ball.invincible ? ball.invincible - 1 : ball.invincible;\n  const coord = ball.coord;\n  const dx = (coord.x + conf.RADIUS > bound.width || coord.x < conf.RADIUS ? -coord.dx : coord.dx) * conf.FRICTION;\n  const dy = (coord.y + conf.RADIUS > bound.height || coord.y < conf.RADIUS ? -coord.dy : coord.dy) * conf.FRICTION;\n  if (Math.abs(dx) + Math.abs(dy) < conf.MINMOVE) return { ...ball,\n    invincible,\n    coord: { ...coord,\n      dx: 0,\n      dy: 0\n    }\n  };\n  return { ...ball,\n    invincible,\n    coord: {\n      x: coord.x + dx,\n      y: coord.y + dy,\n      dx,\n      dy\n    }\n  };\n};\n\nexport const clickEnd = state => event => {\n  if (state.press) {\n    const t = (Date.now() - state.press.start) / 1000;\n    const dx = Math.cos(state.press.pos.x - state.player.coord.x);\n    const dy = Math.sin(state.press.pos.y - state.player.coord.y);\n    console.log(t, dx, dy);\n    state.player.coord.dx = state.player.coord.dx + dx * t;\n    state.player.coord.dy = state.player.coord.dy + dy * t;\n  }\n\n  return state;\n};\nexport const click = state => event => {\n  const {\n    offsetX: x,\n    offsetY: y\n  } = event;\n  state.press = {\n    start: Date.now(),\n    pos: {\n      x,\n      y\n    }\n  };\n  return state;\n};\n\nconst collide = (o1, o2) => dist2(o1, o2) < Math.pow(2 * conf.RADIUS, 2);\n\nconst collideBoing = (p1, p2) => {\n  const nx = (p2.x - p1.x) / (2 * conf.RADIUS);\n  const ny = (p2.y - p1.y) / (2 * conf.RADIUS);\n  const gx = -ny;\n  const gy = nx;\n  const v1g = gx * p1.dx + gy * p1.dy;\n  const v2n = nx * p2.dx + ny * p2.dy;\n  const v2g = gx * p2.dx + gy * p2.dy;\n  const v1n = nx * p1.dx + ny * p1.dy;\n  p1.dx = nx * v2n + gx * v1g;\n  p1.dy = ny * v2n + gy * v1g;\n  p2.dx = nx * v1n + gx * v2g;\n  p2.dy = ny * v1n + gy * v2g;\n  p1.x += p1.dx;\n  p1.y += p1.dy;\n  p2.x += p2.dx;\n  p2.y += p2.dy;\n};\n\nexport const step = state => {\n  state.pos.map((p1, i, arr) => {\n    arr.slice(i + 1).map(p2 => {\n      if (collide(p1.coord, p2.coord)) {\n        if (!p1.invincible) {\n          p1.life--;\n          p1.invincible = 20;\n        }\n\n        if (!p2.invincible) {\n          p2.life--;\n          p2.invincible = 20;\n        }\n\n        collideBoing(p1.coord, p2.coord);\n      }\n    });\n  });\n  if (state.player.invincible) state.player.invincible--;\n  state.pos.map((p1, i) => {\n    if (collide(p1.coord, state.player.coord)) {\n      collideBoing(p1.coord, state.player.coord);\n\n      if (!state.player.invincible) {\n        state.player.life--;\n        state.player.invincible = 20;\n      }\n\n      if (!p1.invincible) {\n        p1.life--;\n        p1.invincible = 20;\n      }\n    }\n  });\n  return { ...state,\n    player: iterate(state.size)(state.player),\n    pos: state.pos.map(iterate(state.size)).filter(p => p.life > 0)\n  };\n};\nexport const mouseMove = state => event => {\n  return state;\n};\nexport const endOfGame = state => state.pos.length > 0;","map":{"version":3,"sources":["/Users/arthur.escriou/workspace/canvas/src/components/canvas/state.ts"],"names":["conf","dist2","o1","o2","Math","pow","x","y","iterate","bound","ball","invincible","coord","dx","RADIUS","width","FRICTION","dy","height","abs","MINMOVE","clickEnd","state","event","press","t","Date","now","start","cos","pos","player","sin","console","log","click","offsetX","offsetY","collide","collideBoing","p1","p2","nx","ny","gx","gy","v1g","v2n","v2g","v1n","step","map","i","arr","slice","life","size","filter","p","mouseMove","endOfGame","length"],"mappings":"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","sourcesContent":["import * as conf from './conf'\ntype Coord = { x: number; y: number; dx: number; dy: number }\ntype Ball = { coord: Coord; life: number; invincible?: number }\ntype Size = { height: number; width: number }\nexport type State = {\n  pos: Array<Ball>\n  press?: { start: number; pos: { x: number; y: number } }\n  size: Size\n  player: Ball\n  endOfGame: boolean\n}\n\nconst dist2 = (o1: Coord, o2: Coord) =>\n  Math.pow(o1.x - o2.x, 2) + Math.pow(o1.y - o2.y, 2)\n\nconst iterate =\n  (bound: Size) =>\n  (ball: Ball): Ball => {\n    const invincible = ball.invincible ? ball.invincible - 1 : ball.invincible\n    const coord = ball.coord\n    const dx =\n      (coord.x + conf.RADIUS > bound.width || coord.x < conf.RADIUS\n        ? -coord.dx\n        : coord.dx) * conf.FRICTION\n    const dy =\n      (coord.y + conf.RADIUS > bound.height || coord.y < conf.RADIUS\n        ? -coord.dy\n        : coord.dy) * conf.FRICTION\n    if (Math.abs(dx) + Math.abs(dy) < conf.MINMOVE)\n      return { ...ball, invincible, coord: { ...coord, dx: 0, dy: 0 } }\n    return {\n      ...ball,\n      invincible,\n      coord: {\n        x: coord.x + dx,\n        y: coord.y + dy,\n        dx,\n        dy,\n      },\n    }\n  }\n\nexport const clickEnd =\n  (state: State) =>\n  (event: PointerEvent): State => {\n    if (state.press) {\n      const t = (Date.now() - state.press.start) / 1000\n      const dx = Math.cos(state.press.pos.x - state.player.coord.x)\n      const dy = Math.sin(state.press.pos.y - state.player.coord.y)\n\n      console.log(t, dx, dy)\n      state.player.coord.dx = state.player.coord.dx + dx * t\n      state.player.coord.dy = state.player.coord.dy + dy * t\n    }\n    return state\n  }\n\nexport const click =\n  (state: State) =>\n  (event: PointerEvent): State => {\n    const { offsetX: x, offsetY: y } = event\n    state.press = { start: Date.now(), pos: { x, y } }\n    return state\n  }\n\nconst collide = (o1: Coord, o2: Coord) =>\n  dist2(o1, o2) < Math.pow(2 * conf.RADIUS, 2)\n\nconst collideBoing = (p1: Coord, p2: Coord) => {\n  const nx = (p2.x - p1.x) / (2 * conf.RADIUS)\n  const ny = (p2.y - p1.y) / (2 * conf.RADIUS)\n  const gx = -ny\n  const gy = nx\n\n  const v1g = gx * p1.dx + gy * p1.dy\n  const v2n = nx * p2.dx + ny * p2.dy\n  const v2g = gx * p2.dx + gy * p2.dy\n  const v1n = nx * p1.dx + ny * p1.dy\n  p1.dx = nx * v2n + gx * v1g\n  p1.dy = ny * v2n + gy * v1g\n  p2.dx = nx * v1n + gx * v2g\n  p2.dy = ny * v1n + gy * v2g\n  p1.x += p1.dx\n  p1.y += p1.dy\n  p2.x += p2.dx\n  p2.y += p2.dy\n}\n\nexport const step = (state: State) => {\n  state.pos.map((p1, i, arr) => {\n    arr.slice(i + 1).map((p2) => {\n      if (collide(p1.coord, p2.coord)) {\n        if (!p1.invincible) {\n          p1.life--\n          p1.invincible = 20\n        }\n        if (!p2.invincible) {\n          p2.life--\n          p2.invincible = 20\n        }\n        collideBoing(p1.coord, p2.coord)\n      }\n    })\n  })\n  if (state.player.invincible) state.player.invincible--\n  state.pos.map((p1, i) => {\n    if (collide(p1.coord, state.player.coord)) {\n      collideBoing(p1.coord, state.player.coord)\n      if (!state.player.invincible) {\n        state.player.life--\n        state.player.invincible = 20\n      }\n      if (!p1.invincible) {\n        p1.life--\n        p1.invincible = 20\n      }\n    }\n  })\n  return {\n    ...state,\n    player: iterate(state.size)(state.player),\n    pos: state.pos.map(iterate(state.size)).filter((p) => p.life > 0),\n  }\n}\n\nexport const mouseMove =\n  (state: State) =>\n  (event: PointerEvent): State => {\n    return state\n  }\n\nexport const endOfGame = (state: State): boolean => state.pos.length > 0\n"]},"metadata":{},"sourceType":"module"}